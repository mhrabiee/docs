worker_processes auto;

events {
	worker_connections  768;
}

http {
	include       mime.types;
	default_type  application/octet-stream;
	sendfile        on;
	keepalive_timeout  65;
	gzip  on;
	gzip_disable "msie6";

	server {
		listen 9192 default_server;
		listen [::]:9192 default_server;

		root /root/docs/build/bin/site;

		server_name _;

		rewrite ^/$ /start/introduction.html last;

		{% for directory in site.redirect_directories %}
		rewrite ^/{{ directory.path }}/?$ /{{ directory.url }} permanent;
		{% endfor %}

		{% for page in site.redirect_pages %}
		{% for redirect in page.previous_url %}
		rewrite ^/{{ redirect | remove_first: '/' }}(\.html)?$ /{{ page.url | remove_first: '/' | replace: '.html', '' }} redirect;
		{% endfor %}
		{% endfor %}

		rewrite ^/sidekick$ /sidekick/intro/introduction redirect;

		location / {
				try_files $uri $uri.html $uri/ @extensionless-html =404;
		}

		location @extensionless-html {
				rewrite ^(.*)$ $1.html last;
		}
	}
}

